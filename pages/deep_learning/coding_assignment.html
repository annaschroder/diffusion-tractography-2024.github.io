
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coding Assignment &#8212; Diffusion MRI</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Feedback" href="../feedback/feedback.html" />
    <link rel="prev" title="Introduction" href="introduction.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      <h1 class="site-logo" id="site-title">Diffusion MRI</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../main.html">
   UCL Summer School: Diffusion MRI
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Diffusion
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../diffusion/introduction.html">
   Introduction to Diffusion MRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../diffusion/diffusion_test.html">
   Check your Understanding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../diffusion/coding_assignment.html">
   Coding Assignment
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tractography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tractography/introduction.html">
   Introduction to Tractography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tractography/tractography_test.html">
   Check your Understanding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tractography/coding_assignment.html">
   Coding Assignment
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Advanced Tractography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/introduction.html">
   MRtrix3 Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/preprocessing.html">
   MRtrix3 DWI Preprocessing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/postprocessing.html">
   MRtrix3 DWI Fibre Estimation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/tractography.html">
   MRtrix3 Tractography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/connectome.html">
   MRtrix3 Connectome Generation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/coding_assignment.html">
   Coding Assignment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../advanced_tractography/bash_intro.html">
   Bash Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Machine Learning
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Coding Assignment
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Anonymous Feedback
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../feedback/feedback.html">
   Feedback
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/pages/deep_learning/coding_assignment.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/diffusion-tractography/diffusion-tractography.github.io/tree/main"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/diffusion-tractography/diffusion-tractography.github.io/tree/main/issues/new?title=Issue%20on%20page%20%2Fpages/deep_learning/coding_assignment.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/tree/main/edit/master/pages/deep_learning/coding_assignment.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="presentation-assignment">
<h1>Deep Learning Assignment<a class="headerlink" href="#presentation-assignment" title="Permalink to this headline">¶</a></h1>
<p><em>by Ellie Thompson</em></p>
<div class="tip admonition">
<p class="admonition-title">Estimated Time</p>
<p>1 hours</p>
</div>
<p>Congratulations on making it through the week! In this practical, we will be segmenting a white matter bundle and comparing our results to those from 
a deep-learning method: TractSeg. </p>

<p> The white matter fibres in the brain are organised into bundles that connect macroscopic brain regions. The large fibre bundles in the brain have been characterised by neuroanatomists, using post-mortem dissection. However, we can use tractography to map these bundles from in-vivo tractography data. In this practical we will try and delineate the optic radiation (sometimes called the posterior thalamic radiation), a tract that connects the thalamus to the visual cortex. It transmits visual information from the retina to the visual cortex, where it can be processed.</p> 



<div style="text-align: center;">
<figure>
<img src="../../_static/img/optic_radiation_schematic.jpg" alt="schematic" style="width:300px;">
<img src="../../_static/img/Optic_Radiation.jpg" alt="colab" style="width:300px;">
<figcaption>Fig.1 - top: a schematic of the optic radiation (source: Davion et all 2020, Brain Topography). bottom: tractography of the optic radiation (source: Yeh, F. C. et al (2018). Neuroimage)</figcaption>
</figure>
</div>

<p> You can find the data for this practical <a href="https://drive.google.com/drive/folders/1PrdOj0Ivb6MZ6WndUeQj0SPgVJGZ8lVC?usp=sharing"> here </a> </p>

<div>
<p> First, download the data. We will start by opening the pre-processed dMRI data and the FA map in mrview (Diffusion.nii.gz and dti_FA.nii.gz). Familiarise yourself with the data. You will want to be in "Ortho View" mode to see all three planes (View->Ortho view).</p> 
</div>

<div>
<p> To map the optic radiation, we need to define a <b>seed region</b> to start the streamlines. This will be located at the thalamus (the optic radiation actually starts in the lateral geniculate nucleus of the thalamus, but to keep things simple we will ignore this detail for now). You can google the thalamus to find out more about its function in the brain, and where it is located.</p> 
</div>

<div>
<p> We have included the Oxford Thalamic Connectivity Probability Atlas in the google folder to help you define the seed region. Open Thalamus-prob-1mm.nii.gz as an overlay in mrview (Tool -> Overlay -> open).</p> 
</div>

<div style="text-align: center;">
<figure>
<img src="../../_static/img/mrview_thalamus.jpg" alt="colab" style="width:461px;height:350px;">
<figcaption>Fig.2 - looking at the thalamus atlas in mrtrix.</figcaption>
</figure>
</div>

<div>
<p> This is a probabilistic atlas - where the higher values indicate voxels that are more likely to be in the thalamus. </p> 
</div>

<div>
<p>Mrtrix requires a binary seed mask, so we will need to threshold and binarise the thalamus atlas to make our seed. You can experiment with different thresholds in mrview until you find one you are happy with. We will then use <a href="https://mrtrix.readthedocs.io/en/latest/reference/commands/mrthreshold.html"> mrthreshold</a> to generate the mask. Using the terminal, cd to the directory containing your data, and run the following:</p>
</div>

<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span> mrthreshold -abs "your threshold value" Thalamus-prob-1mm.nii.gz thalamus_mask.nii.gz
</pre></div>
</div>

<div style="text-align: center;">
<figure>
<img src="../../_static/img/mrview_thalamus_mask.jpg" alt="colab" style="width:461px;height:350px;">
<figcaption>Fig.3 - If you open your new thalamus mask as an overlay in mrview it should look something like this.</figcaption>
</figure>
</div>

<div>
<p>Running tractography with the thalamus as a seed region will give us an estimate of <b> all </b> the white matter connections emanating from the thalamus. If we just want to map the optic radiation we will have to further constrain the tractography process with further masks.  </p>
</div>

<p>To run the tractography we will be using <a href="https://mrtrix.readthedocs.io/en/latest/reference/commands/tckgen.html"> tckgen</a>. We will be using the <b>-include</b> and <b>-exclude</b> flags to retain and exclude streamlines, based on what we know about the trajectory of the optic radiation. </p>

<div style="text-align: center;">
<figure>
<img src="../../_static/img/brain_planes.jpg" alt="colab" style="width:461px">
<figcaption>Fig.4 - The different planes of the brain.</figcaption>
</figure>
</div>

<div>
<p>First of all, we want to make sure that we only include the streamlines that travel in a posterior direction (backwards) from the thalamus towards the visual cortex. We will use mrview to generate an <b>inclusion ROI</b> plane for this. In other words, we will only include streamlines that pass through this mask. Go to Tool->ROI editor and click the green cross in the ROI editor tab to make a new file. Next, move your mouse to select a suitable coronal plane in the visual cortex (see figure 5 for inspiration). Then go to the ROI editor tab and click "edit", then "fill" so that you are using the fill tool. Click anywhere in your coronal plane (top left panel) to make your ROI. Now, save it as "target.nii.gz" using the save icon in the ROI editor tab. </p>
</div>

<div style="text-align: center;">
<figure>
<img src="../../_static/img/target_roi_mrview.jpg" alt="colab" style="width:461px">
<figcaption>Fig.5 - Creating the target ROI in mrview.</figcaption>
</figure>
</div>


<p>Next, try running tractography using these two masks with the command below, and inspect the results. We will use the FACT algorithm to perform deterministic tractography. We have included a file containing the fibre orientation estimates, peaks.nii.gz, which will be our source data. (You can find out more information about the FACT algorithm on the <a href="https://mrtrix.readthedocs.io/en/latest/reference/commands/tckgen.html"> tckgen manual page</a>).</p>


<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span> tckgen -algorithm FACT -seed_image thalamus_mask.nii.gz -include target.nii.gz peaks.nii.gz optic_radiation_1.tck
</pre></div>
</div>

<p>If you open the output file "optic_radiation_1.tck" you will see that the results are quite messy (click Tool->tractography, and then open the file in the Tractography tab).

To remove some of these extra streamlines, we will add some <b>exclusion ROIs</b>. Any streamline that enters an exclusion mask will be discarded.</p>

<p>Use the ROI editor tool to create:

<ul>
  <li>One coronal mask in front of the thalamus.</li>
  <li>One axial mask above the thalamus.</li>
  <li>One axial mask below the thalamus</li>
  <li>One sagittal between the two hemispheres of the brain</li>
</ul>

Look at Figure 6 for placement if you are unsure.
Save them as exclude_1.nii.gz, exclude_2.nii.gz, exclude_3.nii.gz and exclude_4.nii.gz.</p>

<div style="text-align: center;">
<figure>
<img src="../../_static/img/exclusion_masks.jpg" alt="colab" style="width:461px">
<figcaption>Fig.6 - Creating the exclusion ROIs in mrview.</figcaption>
</figure>
</div>

<p>Now run tractography again with the new exclusion masks:</p>

<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span> tckgen -algorithm FACT -seed_image thalamus_mask.nii.gz -include target.nii.gz -exclude exclude_1.nii.gz -exclude exclude_2.nii.gz -exclude exclude_3.nii.gz -exclude exclude_4.nii.gz peaks.nii.gz optic_radiation_2.tck
</pre></div>
</div>

<p>Open the new tractography result in mrview and take a look. You should be able to clearly see the optic radiation bundles now, with fewer erroneous streamlines. </p>


<p>We can now compare our results with the results from TractSeg. As we saw in the slides, TractSeg... We have already run TractSeg on this dataset and saved the results in "Peaks_FACT_trackings" to save time, but if you'd like try to running the pre-trained model yourself, you can find the instructions on the <a href="https://github.com/MIC-DKFZ/TractSeg"> TractSeg github page</a>.




    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./pages/deep_learning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="introduction.html" title="previous page">Introduction</a>
    <a class='right-next' id="next-link" href="../feedback/feedback.html" title="next page">Feedback</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By UCL–CMIC Summer School<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>
